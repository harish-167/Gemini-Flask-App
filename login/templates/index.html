{% extends "base.html" %}

{% block title %}Gemini AI Chat{% endblock %}

{% block content %}
<div class="container">
    <h1>Interact with Gemini AI</h1>

    <div id="conversationHistory"></div>

    <textarea id="promptInput" placeholder="Enter your prompt here..." rows="5"></textarea>
    <button id="generateButton">Generate Text</button>
    <div id="loading" class="hidden">Generating...</div>
    <div id="errorContainer" class="hidden">
        <p id="errorMessage"></p>
    </div>
</div>

<script>
// The script remains the same
document.addEventListener('DOMContentLoaded', () => {
    const promptInput = document.getElementById('promptInput');
    const generateButton = document.getElementById('generateButton');
    const conversationHistoryDiv = document.getElementById('conversationHistory');
    const loadingDiv = document.getElementById('loading');
    const errorContainer = document.getElementById('errorContainer');
    const errorMessage = document.getElementById('errorMessage');

    let conversation = [];

    function displayMessage(role, text) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', role);
        let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                .replace(/\n/g, '<br>');

        messageDiv.innerHTML = `<strong>${role === 'user' ? 'You' : 'Gemini'}:</strong> ${formattedText}`;
        conversationHistoryDiv.appendChild(messageDiv);
        conversationHistoryDiv.scrollTop = conversationHistoryDiv.scrollHeight;
    }

    generateButton.addEventListener('click', async () => {
        const prompt = promptInput.value.trim();
        if (!prompt) {
            alert('Please enter a prompt!');
            return;
        }
        displayMessage('user', prompt);
        conversation.push({ role: 'user', parts: [{ text: prompt }] });

        promptInput.value = '';
        errorContainer.classList.add('hidden');
        errorMessage.textContent = '';
        loadingDiv.classList.remove('hidden');
        generateButton.disabled = true;

        try {
            const response = await fetch('/generate_text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt, history: conversation })
            });

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();
                throw new Error(data.error || 'Something went wrong.');
            }

            const data = await response.json();
            displayMessage('model', data.generated_text);
            conversation = data.history;

        } catch (error) {
            errorContainer.classList.remove('hidden');
            errorMessage.textContent = `Error: ${error.message}`;
            conversation.pop();
        } finally {
            loadingDiv.classList.add('hidden');
            generateButton.disabled = false;
            promptInput.focus();
        }
    });

    promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            generateButton.click();
        }
    });
});
</script>
{% endblock %}